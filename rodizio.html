<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rodízio de Cultos — CCB</title>

<style>
:root{
  --border:#7a7a7a;
  --blue:#dbe7ff;
  --orange:#f4e0c8;
  --red:#f8d6d6;
  --batismo:#fff2a8;
}
body{font-family:Arial,sans-serif;margin:0;background:#f4f4f4}
.wrap{max-width:1100px;margin:20px auto;background:#fff;padding:16px}
h1{text-align:center;margin:0}
.controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0}
button,input,select{padding:8px;font-size:14px}
button{cursor:pointer}
.btn{background:#2e6be6;color:#fff;border:none}
.btn-red{background:#c62828;color:#fff;border:none}

textarea{width:100%;min-height:70px}

.title{margin-top:14px;font-weight:bold}
table{width:100%;border-collapse:collapse;margin-bottom:16px}
th,td{border:1px solid var(--border);padding:6px}
th{background:#eee}
.batismo{background:var(--batismo)!important;font-weight:bold}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
<div class="wrap">

<h1>RODÍZIO MENSAL — CCB</h1>

<div class="controls">
  <input type="month" id="monthPick">
  <button class="btn" onclick="gerarRodizio()">Gerar</button>
  <button class="btn" onclick="salvarRodizio()">Salvar</button>
  <button class="btn-red" onclick="exportarPDF()">Exportar PDF</button>
</div>

<div class="controls">
  <select id="consultaMes"></select>
  <button onclick="consultarRodizio()">Consultar mês salvo</button>
</div>

<div class="title">Operadores (1 por linha)</div>

<textarea id="opsCulto">ABIMAEL
DANIEL
FABIO
JONATAS</textarea>

<textarea id="opsReuniao">ABIMAEL
DANIEL</textarea>

<textarea id="opsEnsaio">JONATAS</textarea>

<textarea id="opsCultoJovem">FABIO</textarea>

<div id="resultArea"></div>

</div>

<script>
const meses=['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'];
const dias=['DOM','SEG','TER','QUA','QUI','SEX','SAB'];

function parse(txt){return txt.split('\n').map(x=>x.trim()).filter(Boolean);}

function gerarRodizio(){
 const mes=document.getElementById('monthPick').value;
 if(!mes) return alert('Escolha o mês');
 const [y,m]=mes.split('-').map(Number);
 const opsC=parse(opsCulto.value);
 const opsR=parse(opsReuniao.value);
 const opsE=parse(opsEnsaio.value);
 const opsJ=parse(opsCultoJovem.value);
 let iC=0,iR=0;

 let html=`<h3 style="text-align:center">${meses[m-1]} / ${y}</h3>`;

 html+=tabela('CULTOS',[0,2,4],opsC,()=>opsC[iC++%opsC.length],y,m);
 html+=tabela('REUNIÃO DE JOVENS',[0],opsR,()=>opsR[iR++%opsR.length],y,m);
 html+=especial('ENSAIO',5,2,opsE,y,m);
 html+=especial('CULTO DE JOVENS',6,2,opsJ,y,m);

 resultArea.innerHTML=html;
 aplicarBatismos();
}

function tabela(titulo,diasSemana,ops,next,y,m){
 let h=`<table><tr><th colspan="4">${titulo}</th></tr>
 <tr><th>Dia</th><th>Data</th><th>Irmão</th><th>Batismo</th></tr>`;
 let d=new Date(y,m-1,1);
 while(d.getMonth()==m-1){
  if(diasSemana.includes(d.getDay())){
   const id=`${y}-${m}-${d.getDate()}`;
   h+=`<tr data-dia="${id}">
   <td>${dias[d.getDay()]}</td>
   <td>${d.getDate()}/${m}</td>
   <td>${next()}</td>
   <td><input type="checkbox" onchange="toggleBatismo('${id}')"></td>
   </tr>`;
  }
  d.setDate(d.getDate()+1);
 }
 return h+'</table>';
}

function especial(titulo,diaSemana,ordem,ops,y,m){
 let d=new Date(y,m-1,1),c=0;
 while(d.getMonth()==m-1){
  if(d.getDay()==diaSemana){c++;if(c==ordem)break;}
  d.setDate(d.getDate()+1);
 }
 if(d.getMonth()!=m-1) return '';
 const id=`${y}-${m}-${d.getDate()}`;
 return `<table><tr><th colspan="4">${titulo}</th></tr>
 <tr><th>Dia</th><th>Data</th><th>Irmão</th><th>Batismo</th></tr>
 <tr data-dia="${id}">
 <td>${dias[d.getDay()]}</td>
 <td>${d.getDate()}/${m}</td>
 <td>${ops[0]}</td>
 <td><input type="checkbox" onchange="toggleBatismo('${id}')"></td>
 </tr></table>`;
}

/* ===== BATISMO ===== */
function toggleBatismo(id){
 const map=JSON.parse(localStorage.getItem('batismos')||'{}');
 map[id]=!map[id];
 localStorage.setItem('batismos',JSON.stringify(map));
 aplicarBatismos();
}
function aplicarBatismos(){
 const map=JSON.parse(localStorage.getItem('batismos')||'{}');
 document.querySelectorAll('[data-dia]').forEach(tr=>{
  if(map[tr.dataset.dia]) tr.classList.add('batismo');
  else tr.classList.remove('batismo');
 });
}

/* ===== SALVAR / CONSULTAR ===== */
function salvarRodizio(){
 const mes=monthPick.value;
 if(!mes) return;
 localStorage.setItem('rodizio-'+mes,resultArea.innerHTML);
 atualizarConsulta();
 alert('Rodízio salvo');
}

function consultarRodizio(){
 const mes=consultaMes.value;
 if(!mes) return;
 resultArea.innerHTML=localStorage.getItem('rodizio-'+mes);
 aplicarBatismos();
}

function atualizarConsulta(){
 consultaMes.innerHTML='<option value="">Consultar mês</option>';
 Object.keys(localStorage).filter(k=>k.startsWith('rodizio-')).sort().forEach(k=>{
  const m=k.replace('rodizio-','');
  consultaMes.innerHTML+=`<option value="${m}">${m}</option>`;
 });
}

/* ===== PDF ===== */
function exportarPDF(){
 html2pdf().from(resultArea).set({
  filename:'rodizio.pdf',
  html2canvas:{scale:2},
  jsPDF:{format:'a4'}
 }).save();
}

/* INIT */
monthPick.value=new Date().toISOString().slice(0,7);
gerarRodizio();
atualizarConsulta();
</script>

</body>
</html>
